<!DOCTYPE html>
<html>
<head>
    <title>Family Management Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Family Management Flow Test</h1>
    
    <button class="button" onclick="loginAndRedirect()">Login and Go to Family Page</button>
    <button class="button" onclick="checkCurrentStorage()">Check Current Storage</button>
    <button class="button" onclick="clearAndTest()">Clear Storage and Test</button>
    
    <div id="results"></div>

    <script>
        function log(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<div class="result">' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }

        async function loginAndRedirect() {
            try {
                // First, login via API
                log('Attempting to login...');
                const response = await fetch('/api/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'newuser@example.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    log('Login successful, saving to sessionStorage...');
                    
                    // Save authentication data exactly like the login page does
                    sessionStorage.setItem('authToken', data.token);
                    sessionStorage.setItem('userId', data.userId);
                    sessionStorage.setItem('username', data.username);
                    sessionStorage.setItem('email', data.email);
                    sessionStorage.setItem('languagePreference', data.languagePreference || 'en');
                    
                    log('Data saved. Token starts with: ' + data.token.substring(0, 30) + '...');
                    log('Username: ' + data.username);
                    
                    // Wait a moment then redirect
                    setTimeout(() => {
                        log('Redirecting to family management page...');
                        window.location.href = 'family-management.html';
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    log('Login failed: ' + errorData.message);
                }
            } catch (error) {
                log('Login error: ' + error.message);
            }
        }

        function checkCurrentStorage() {
            log('Checking current sessionStorage...');
            log('authToken: ' + (sessionStorage.getItem('authToken') ? 'EXISTS' : 'MISSING'));
            log('username: ' + (sessionStorage.getItem('username') || 'MISSING'));
            log('userId: ' + (sessionStorage.getItem('userId') || 'MISSING'));
            log('email: ' + (sessionStorage.getItem('email') || 'MISSING'));
            
            const token = sessionStorage.getItem('authToken');
            if (token) {
                log('Token preview: ' + token.substring(0, 50) + '...');
            }
        }

        function clearAndTest() {
            sessionStorage.clear();
            log('SessionStorage cleared');
            checkCurrentStorage();
        }
    </script>
</body>
</html>
